<?php
require('header.php');

wp_enqueue_style('thickbox'); 
wp_enqueue_script('thickbox'); 


if($_REQUEST['select_bulk'])
    {
        if($_REQUEST['select_bulk'] == 'trash'){
          $data_trash = array('status' => 3); 

          if($_REQUEST['ckp'])
          {
            foreach($_REQUEST['ckp'] as $catalog_id)  
            {   
              //echo "SELECT cid FROM `store_catalog` WHERE `cid` = '".$catalog_id."' AND status=0";  
              $check_exist_trash = $wpdb->get_var("SELECT ass_cid FROM `store_catalog` WHERE `cid` = '".$catalog_id."'");  
              if($check_exist_trash){
                $wh_cat = array('ass_cid' => $check_exist_trash);     
                $wpdb->update('store_catalog',$data_trash,$wh_cat);  /* trash catalog in main catalog table*/
                $wpdb->update('store_designer',$data_trash,$wh_cat);  /* trash catalog in designer table*/
                $wpdb->update('store_data',$data_trash,$wh_cat);  /* trash catalog in data entry table*/
                $wpdb->update('store_seo',$data_trash,$wh_cat);  /* trash catalog in SEO table*/
                $wpdb->update('sheet_check',$data_trash,$wh_cat);  /* trash catalog in Sheet check table*/
              }
            }
          }
        }
        elseif($_REQUEST['select_bulk'] == 'restore'){
          $data_trash = array('status' => 1);       
          if($_REQUEST['ckp'])
          {
            foreach($_REQUEST['ckp'] as $catalog_id)  
            {     
              $check_exist_trash = $wpdb->get_var("SELECT cid FROM `store_catalog` WHERE `cid` = '".$catalog_id."' AND status=3");  
              if($check_exist_trash){
                $wh_cat = array('cid' => $catalog_id);  
                $wpdb->update('store_catalog',$data_trash,$wh_cat);
              }
            }
          }
        }
      }



if(isset($_REQUEST['action']) && $_REQUEST['action']=="get_catalog")
{
  
  $array_print = json_decode($client->call('Login',$addshare_array)); //call webservice with array parameter
  $web_inv_code=array('Authentication_Ticket'=>$array_print->Authentication_Ticket);
  
  $inv_code= $client->call('Album_List',$web_inv_code); //call webservice with array parameter      
  
  $catalog_list = json_decode($inv_code); 
 // echo "<pre>";print_r($catalog_list);die;
  

  if($catalog_list){
  
    
    $category_lists = $wpdb->get_results("SELECT ass_cat_id,product_type,prefix FROM `ass_cat_map` ");
    foreach($category_lists as $category){  
      $exist_cat[$category->ass_cat_id] = array('product_type' => $category->product_type,'prefix' => $category->prefix);
    } 
      
    foreach($catalog_list as $catalog){ 
      if(!$wpdb->get_row("SELECT cid FROM `store_catalog` WHERE `ass_cid` ='".$catalog->catelog_id."'")){
        
        $whol_flag = 0;
        //echo $catalog->catalog_type;die;
        if($catalog->catalog_type == 'Catalog') 
        {     
          $whol_flag=1;
        }
		
		$supplier_id=$wpdb->get_var("SELECT * FROM `supplier` where supplier_name like '%".$catalog->supplier_name."%'");
          echo "SELECT * FROM `supplier` where supplier_name like '%".$catalog->supplier_name."%'";die;
        $catalog = array(
                 'ass_cid'      => $catalog->catelog_id,
                 'c_name'       => $catalog->catalog_name,
                 'tot_product'  => $catalog->total_product,
                 'supplier_name'=> $catalog->supplier_name,
				 'supplier_id' =>    $supplier_id,
                 'entry_date' => date('Y-m-d h:i:s'),
                 'product_type' => $exist_cat[$catalog->category_id]['product_type'],
                 'prefix'   => $exist_cat[$catalog->category_id]['prefix'],
                 'ads_ins_date' =>$catalog->upload_date,
                 'whol_flag'  =>$whol_flag
              );
          
        $wpdb->insert('store_catalog',$catalog);
        unset($catalog);  
      }
    }
  }
  ?>
  <script type="text/javascript">
  
    window.location='<?php echo get_site_url()."/wp-admin/admin.php?page=store_admin_LT";?>';
  
  </script>
  <?php
  
  }

 /* if(isset($_REQUEST['action']) && $_REQUEST['action']='approved_catalog')
  {
      echo 'manish';
      exit;

  }*/

  if(isset($_REQUEST['action']) && $_REQUEST['action']=='single_catalog')
  {

     $catelog_code = $_REQUEST['id'];
    $array_print  = json_decode($client->call('Login',$addshare_array)); //call webservice with array parameter
    $web_inv_code = array('Authentication_Ticket'=>$array_print->Authentication_Ticket,'Album_Id'=>$catelog_code);  
    $product_list = $client->call('Album_Product',$web_inv_code); //call webservice with array parameter   
    $product_data = json_decode($product_list); //print output
    
    $db_exist_ass_list  = $wpdb->get_col("SELECT ass_no FROM `store_catalog_data` WHERE 1 AND status !=3 AND `cid` LIKE '$catelog_code'");  
    $exist_cat_our_name = $wpdb->get_var("SELECT our_name FROM `catalog` WHERE `ass_cid` LIKE '$catelog_code'"); 
	$catalog_status = $wpdb->get_var("SELECT status FROM `catalog` WHERE `ass_cid` LIKE '$catelog_code'"); 
    ?>

    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">

          <h3><i class="glyphicon glyphicon-user"></i>Single Catlog</h3>

          <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i>Catalog Upload</a></li>
            <li>Ass Catalog</li>
            <li>Catalog List</li>
            <li class="active"><?php echo $_REQUEST['c_name']; ?></li>
          </ol>
        </section>
         
        <!-- Main content -->
         <form name="frm_approve_catlog" id="frm_approve_catlog" method="get" action="">

          <input type="hidden" name="page" value="<?php echo $_REQUEST['page'];?>"  />            
          <input type="hidden" name="id" value="<?php echo $_REQUEST['id'];?>"  />            
          <input type="hidden" name="c_name" value="<?php echo $_REQUEST['c_name']?>"  />      
          <input type="hidden" name="action" value="approved_catalog"  />
        <section class="content">

       

                <div class="box box-info" >
                  <div class="box-header" >
                    <h3 class="box-title"><i class="glyphicon glyphicon-list"></i><?php echo $_REQUEST['c_name']; ?></h3>
                    <div class="box-tools">
                         <h5><i class="fa fa-clock-o"></i>Total Product: <?php echo count($product_data);?></h5>
                    </div>
                  </div>
                   

          <div class="row">
            <div class="col-xs-12">
              
              
              
              <div>
               
                <div class="row">
            
                </div>
                <div class="box-body">

                  <table id="example2" class="table table-bordered table-striped">
                    <thead>
                      <tr>

                        <th><input type="checkbox" name="chk_all_grp" id="chk_all_grp" class="minimal"></th>
                        <th>No.</th>
                        <th>Image</th>
                        <th>Title</th>
                        <th>ASS No</th>
                        <th>Design No.</th>
                        <th>Price</th>
                        <th>Delivery Time</th>
                        <th>Availability</th>
                        <th>Color</th>
                        <th>Material</th>
                        <th>Uploaded</th>

                      </tr>
                    </thead>

                    <tbody>
                      <?php $i=1;
  
                      foreach($product_data as $product)
                      {?>
                      <tr>    
                      <td class="center"><input type="checkbox" class="ckp" name="ckp[]" value="<?php echo $product->ass_no;?>" /></td>
                      <td><?php echo  $i; ?></td>
                      <td><a href="<?php echo $product->main_image;?>" class="thickbox"><img src="<?php echo $product->main_image_50_50_thumb; ?>" /></a></td>
                      <td><?php echo $product->titel; ?></td>
                      <td><?php echo $product->ass_no; ?></td>
                      <td><?php echo $product->design_no; ?></td>    
                      <td><?php echo $product->price; ?></td>
                      <td><?php echo $product->delivery_time; ?></td>
                      <td>
                      <?php echo ($product->availability =="Available")?'<a class="btn btn-success btn-xs" ><i class="fa fa-check"></i></a>':'<a class="btn btn-danger btn-xs" ><i class="fa fa-close"></i></a>';?>
                      </td>
                      <td><?php  echo  $product->color;?></td>
                      <td><?php echo  $product->material;?></td>    
                      <td>
                        <?php echo (in_array($product->ass_no,$db_exist_ass_list))?'<a class="btn btn-success btn-xs" ><i class="fa fa-check"></i></a>':'<a class="btn btn-danger btn-xs" ><i class="fa fa-close"></i></a>';?>
                      </td>
                      </tr>
                      <?php 

                      $i++;

                      }?>                      
                      
                    </tbody>
                    <tfoot>
                      <tr>

                        <th><input type="checkbox" name="chk_all_grp" id="chk_all_grp" class="minimal"></th>
                        <th>No.</th>
                        <th>Image</th>
                        <th>Title</th>
                        <th>ASS No</th>
                        <th>Design No.</th>
                        <th>Price</th>
                        <th>Delivery Time</th>
                        <th>Availability</th>
                        <th>Color</th>
                        <th>Material</th>
                        <th>Uploaded</th>

                      </tr>
                    </tfoot>
                    
                  </table>

                  <div class="box-body" >
                        <div class="row" >

                          <div class="col-md-12">
                          
                          <div class="col-md-3" >
                            <input type="text" name="txt_cat_name_search" id="txt_cat_name_search" placeholder="Catalog" class="form-control" value="" />
                          </div>

                          <div class="col-md-3" >
                          <input type="button" name="bt_apply" id="bt_apply" value="Check Name" onclick="checkCNameAvailability();" class="btn btn-primary"/>
                          </div>

                          <div class="btn-group btn-group pull-right">
                            <a href="javascript:history.go(-1)" class="btn btn-danger">Go Back</a>
                            <button type="button" class="btn btn-success" name="bt_approve" id="bt_approve" >Approved</button>
                            
                            <?php
                              $href='?page='.$_REQUEST['page'].'&id='.$_REQUEST['id'].'&c_name='.$_REQUEST['c_name'].'&action=duplicate_catalog';
                            ?>
                            <a href="<?php echo $href; ?>" class="btn btn-default" name="bt_duplicate" id="bt_duplicate">Duplicate</a>
                          </div>


                          </div>


                    </div> 
                  </div>

                </div><!-- /.box-body -->
              </div><!-- /.box -->
            </div><!-- /.col -->
          </div><!-- /.row -->
        </section><!-- /.content -->
        </form>
      </div><!-- /.content-wrapper -->
    
    <?php

  }
  else if(isset($_REQUEST['action']) && $_REQUEST['action']=='approved_catalog')
  {

    $cat_from_db = $wpdb->get_row("SELECT * FROM `store_catalog` WHERE `ass_cid` ='".$_REQUEST['id']."'");
     ?>
  	<div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">

          <h3><i class="glyphicon glyphicon-user"></i>Mastani</h3>

          <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i>Catalog</a></li>
            <li class="active">Catalog List</li>
            <li> <a href="admin.php?page=store_admin_LT&action=single_catalog&id=<?php echo $_REQUEST['id'];?>&c_name=<?php echo $_REQUEST['c_name'];?>"> <?php echo $_REQUEST['c_name'];?> </a> </li>
            <li> Uploading... </li>
          </ol>
        </section>
          
        <!-- Main content -->
         <form method="get" action="">

<?php foreach($_REQUEST['ckp'] as $key => $request){?>
        <input type="hidden" name="passed_product[]" value="<?php echo $request;?>" />
  <?php }?>  
  <?php foreach($_REQUEST as $key => $request){?>
      <input type="hidden" name="<?php echo $key;?>"  value="<?php echo $request;?>"/>
  <?php }?>
        <section class="content">

                <div class="box box-info" >
                  <div class="box-header" >
                    <h3 class="box-title"><i class="glyphicon glyphicon-list"></i>&nbsp;&nbsp;<?php echo $_REQUEST['c_name'];?></h3>
                    <div class="box-tools">
                          <button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                    </div>
                  </div>
                    <div class="box-body" >
                        <div class="row" >

                        <div class="col-md-2">
                        <label>	Select Catagory Type:</label>
                        </div>		
                          <div class="col-md-3" >
                            <select name="category_type" id="category_type">
                              <?php 
                              if(isset($cat_from_db->product_type) && $cat_from_db->product_type!='')
                              { 
                              $get_category=$wpdb->get_results("SELECT t_taxo.term_taxonomy_id,t_taxo.taxonomy,t_taxo.parent,t_taxo.term_id,terms.name,terms.slug FROM wp_terms as terms
                                                INNER JOIN wp_term_taxonomy as t_taxo  ON terms.term_id=t_taxo.term_id
                                                where t_taxo.taxonomy='wpsc_product_category' AND terms.slug='".$cat_from_db->product_type."'");
                              foreach ($get_category as $get_category_row) {
                              $get_category_parent=$wpdb->get_row("SELECT terms.name,terms.slug,terms.term_id FROM wp_terms as terms
                                                where terms.term_id='$get_category_row->parent'");   
                              ?>
                              <option value="<?php echo $get_category_parent->term_id;?>"><?php echo $get_category_parent->name?></option> 
                              <?php }    

                              }
                              else
                              {
                              $get_category=$wpdb->get_results("SELECT t_taxo.term_taxonomy_id,t_taxo.taxonomy,t_taxo.parent,t_taxo.term_id,terms.name,terms.slug FROM wp_terms as terms
                                                INNER JOIN wp_term_taxonomy as t_taxo  ON terms.term_id=t_taxo.term_id
                                                where t_taxo.taxonomy='wpsc_product_category'");
                              ?>
                              <option value="">Select</option>
                              <?php
                              foreach ($get_category as $get_category_row) {
                              //if($get_category_row->parent != 3 && $get_category_row->parent != 0)
                              if($get_category_row->parent == 0)
                              {
                              ?>
                              <option <?php if($category_type == $get_category_row->term_taxonomy_id) echo "selected";?> value="<?php echo $get_category_row->term_taxonomy_id;?>"><?php echo $get_category_row->name?></option> 
                              <?php }     
                              }
                              }   
                              ?> 
                            </select>
                         </div>
                    </div>
                     </div> 


                     <div class="box-body" >
                        <div class="row" >    

                         <div class="col-md-2">
                        <label>	Select Product Type: </label>
                        </div>
                          <div class="col-md-3" >
                             <?php 
        
                        if(isset($cat_from_db->product_type) && $cat_from_db->product_type!='')
                        { ?>
                          <select name="product_type" id="product_type">
                            <option <?php echo 'selected="selected"';?> value="<?php echo $cat_from_db->product_type;?>"><?php echo $cat_from_db->product_type;?></option>
                          </select>
                                      
                        <?php 
                        }else
                        {?>
                            <select name="product_type" id="product_type">
                          <option value="">Select</option>
                          </select>
                            <?php } ?> 
                          </div>

                     </div>
                     </div> 
                     


                    <div class="box-body" >
                        <div class="row" >  

                         <div class="col-md-2">
                         <label>Select SKU Prefix:</label>
                         </div>	
                          <div class="col-md-3" >
                          <?php if(isset($cat_from_db->prefix) && $cat_from_db->prefix!='')
                          { ?>
                               <select name="sku_prefix" id="sku_prefix">
                            <option <?php echo 'selected="selected"';?> value="<?php echo $cat_from_db->prefix;?>"><?php echo $cat_from_db->prefix;?></option>    
                          </select>
                              <?php 
                          } 
                          else 
                          { ?> 
                                <select name="sku_prefix" id="sku_prefix">
                              <option value="">Select</option>
                              
                            </select>
                                
                          
                          <?php }  ?>
                          </div>

                     </div>
                     </div>     

                     <div class="box-body" >
                        <div class="row" >

                         <div class="col-md-2">
                         <label>Publish Status:</label>
                         </div> 
                          <div class="col-md-3" >
                           <select name="public_status">
                            <option <?php echo ($public_status=="publish")?('selected="selected"'):"";?> value="publish">Publish</option>
                            <option <?php echo ($public_status=="trash")?('selected="selected"'):"";?> value="trash">Draft</option>
                            </select>
                            
                          </div>
                    </div>
                       </div>

                 <div class="box-body" > 
                        <div class="row" >      
                         <div class="col-md-6" >

                          <a href="javascript:history.go(-1)" class="btn btn-danger">Go Back</a>		
                          <?php if(1){?>
                          <input type="submit" name="insert_product_entry" id="insert_product_entry" value="Upload Product" class="btn btn-primary"/>
                          <?php } ?>
                     
                          
                          </div>
    

                    </div> 
              </div>
       

          
        </section><!-- /.content -->
        </form>
      </div><!-- /.content-wrapper -->


      <?php     

        //if($insert_product_entry && $cat_from_db->status == 0){   
        if($_REQUEST['insert_product_entry'])
        {    
          
          $catelog_code = $_REQUEST['id'];
          $array_print  = json_decode($client->call('Login',$addshare_array)); //call webservice with array parameter

          $web_inv_code = array('Authentication_Ticket'=>$array_print->Authentication_Ticket,'Album_Id'=>$catelog_code);  

          $product_list = $client->call('Album_Product',$web_inv_code); //call webservice with array parameter   

          $product_data = json_decode($product_list); //print output                  
          
          //echo "<pre>";print_r($product_data);echo "</pre>";      

          $last_sku = $wpdb->get_var("SELECT sku_code FROM `store_catalog_data` ORDER BY `store_catalog_data`.`id` DESC");

          if($last_sku){

            preg_match_all('!\d+!', $last_sku, $matches);   

            $last_product_no = $matches[0][0] +1;   

          }else{
            $last_product_no = 20000;
          }   
          /* store plugin catalog */
          $catalog = $wpdb->get_row("SELECT * FROM `store_catalog` WHERE `ass_cid` LIKE '".$_REQUEST['id']."'");
                    $catalog_type='';
          if($product_type=='sarees')
          {
            $catalog_type='saree';
          }
          else if($product_type=="kurtis")
          {
            $catalog_type='kurti';
          }
          else if($product_type=="dresses")
          {
            $catalog_type='salwar suit';
          }
          else if($product_type=="jens")
          {
            $catalog_type='jeans';
          }
          else if($product_type=="jewellery")
          {
            $catalog_type='accessories';
          }
          /* check supplier exist start*/
          $exist_sup   = $wpdb->get_var("SELECT id FROM `supplier` WHERE `supplier_name` LIKE '".$catalog->supplier_name."'");
          $exist_cat = $wpdb->get_var("SELECT id FROM `catalog` WHERE `catalog_name` LIKE '".$catalog->c_name."' AND `ass_cid` = '".$_REQUEST['id']."' ");
          if($exist_sup)
          {
              if(!$exist_cat)
              {   
                $cat_ins_data = array(
                            'catalog_name' => $catalog->c_name,
                                                      'our_name'     => $_REQUEST['our_name'],
                            'ass_cid'    => $catelog_code,
                            'supplier_id'  => $exist_sup,
                            'qty'      => $catalog->tot_product,
                            'edate'    => date('Y-m-d h:i:s'),
                                                      'catalog_type' => $catalog_type,
                            'whol_flag' =>$catalog->whol_flag
                           );
                $wpdb->insert('catalog',$cat_ins_data); /*insert new Catalog*/      
              } 
          }
          else
          {
            /*insert new supplier first*/ 
            $wpdb->insert('supplier',array('supplier_name' => $catalog->supplier_name));
            $exist_sup   = $wpdb->get_var("SELECT id FROM `supplier` WHERE `supplier_name` LIKE '".$catalog->supplier_name."'");
            if(!$exist_cat)
            {
              $cat_ins_data = array(
                          'catalog_name' => $catalog->c_name,
                                                  'our_name'     => $_REQUEST['our_name'],
                          'ass_cid'    => $catelog_code,
                          'supplier_id'  => $exist_sup,
                          'qty'      => $catalog->tot_product,
                          'edate'    => date('Y-m-d h:i:s'),
                                                  'catalog_type' => $catalog_type,
                          'whol_flag' =>  $catalog->whol_flag
                         );
              $wpdb->insert('catalog',$cat_ins_data); /*insert new Catalog*/  
            }
            
          }   
          /* check supplier exist end*/
          
          $tot_ins_pro   = 0;
          $total_sale_price= 0;
          foreach($product_data as $product)  
          { 
            $not_exist_pro = $wpdb->get_row("SELECT id,sku_code FROM `store_catalog_data` WHERE `ass_no` LIKE '".$product->ass_no."'");
            if(!$not_exist_pro)
            {
              /*check condition for id product have permissoin for uploading...*/
              if(in_array($product->ass_no,$passed_product)){
                
                $thumb_image = str_replace(' ','%20',$product->main_image_50_50_thumb);
                if(file_get_contents($thumb_image)) 
                {
                /*commented by vijay for change in webservice of addsharesale on 23_11_2014*/ 
                /*
                $color_data[] = $product->primary_color;
                $color_data[] = $product->secondary_color;
                $color_data[] = $product->color3;
                $color_data[] = $product->color4;
                
                $material_data[] = $product->primary_material;
                $material_data[] = $product->secondary_material;
                $material_data[] = $product->material3;
                $material_data[] = $product->material4; 
                
                $occasion_data[] = $product->primary_occasion;
                $occasion_data[] = $product->secondary_occasion;
                */
                /*commented by vijay for change in webservice of addsharesale on 23_11_2014*/ 
                
                $sku    = $sku_prefix.$last_product_no; 
                $sale_price = fnGetCalPrice($product->price,$product->);
                $total_sale_price = $total_sale_price + $sale_price;
                /*just check if image main original price exist on ASS or not  by_vijay start*/
                /*if(file_exists(str_replace(' ','%20',$product->full_image1)))
                {
                  $main_original_image = $product->full_image1; 
                }else{
                  $main_original_image = $product->main_image;    
                }*/
                /*just check if image main original price exist on ASS or not  by_vijay end*/             
                
                $main_original_image  = $product->full_image1;
                $extra_original_image = "";
                $extra_original_image[] = $product->full_image2;
                $extra_original_image[] = $product->full_image3;
                $extra_original_image[] = $product->full_image4;

                $extra_original_image = array_filter($extra_original_image);
                if($extra_original_image)
                  $extra_original_image = implode('||',$extra_original_image);
                else
                  $extra_original_image = "";
                
                $product_details = array(     
                          'cid'     => $catelog_code,
                          'ass_no'  => $product->ass_no,  
                          'sku_code'  => $sku,                
                          'price'   => round($sale_price, -1), 
                          'stock_limited' => 'yes',
                          'quantity'  => ($product->availability =="Available")?"":0,
                          'catalog' => trim($c_name),
                          'merchant_name' => $product->supplier_name,
                          'design_no' => $product->design_no,
                          'color'   => $product->color,
                          'fabric'  => $product->material,  
                          'occasion'  => $product->occasion,  
                          'product_type' => $product_type,
                          'kurti_size' => $product->size,
                          'image_upload_type' => "folder",  
                          'original_image'  => $main_original_image,
                          'tumb_image'  => $product->main_image_50_50_thumb,                
                          'main_thumb'  => $product->main_image_thumb,
                          'public_status'  => $public_status,         
                          'add_update'  => 'Add',   
                          'suplier_name' => $product->supplier_name,
                          'original_price' => $product->price,
                          'extra_original_image' =>$extra_original_image,
                          'note'    => $product->note,    
                          'entry_date'=> date('Y-m-d h:i:s')
                           ); 
                //echo "<pre>";print_r($product_details);echo "</pre>";die;
  
                $wpdb->insert("store_catalog_data",$product_details);  // remove comment             
                $last_product_no++;   $tot_ins_pro++;     
                unset($color_data,$material_data,$occasion_data);
              }
                else
                  $msg[]="Thumb not Exist <br/>";
              }
              else
              {
                $msg[].=$product->ass_no . "Product not passed in Array <br/>";
              }
            }     
            else
            {   
                 $msg[].="SKU already exist <br/>";
              
            }         
          }
          // Update Catalog Entry
          $full_catalog_price = $wpdb->get_row("SELECT SUM(price) as tot_price, count(*) as cnt, SUM(original_price) as tot_orignal FROM `store_catalog_data` WHERE 1 AND status !=3 AND `cid` = '".$cat_from_db->ass_cid."' ");                  
          
          $exist_cat_id = $wpdb->get_var("SELECT id FROM `catalog` WHERE `catalog_name` LIKE '".$catalog->c_name."' AND ass_cid ='".$catalog->ass_cid."' ");
          // update entry in pavitraa/ff updated @ 24-sep by rahul for orignal price 
          $catalog_data = $wpdb->update('catalog',array('ass_cid'=> $catelog_code,'price' => $full_catalog_price->tot_price,'orignal_price'=>$full_catalog_price->tot_orignal),array('id' => $exist_cat_id));  // remove comment                            
          //update status in catalog store plugin table
          $catalog_data = $wpdb->update('store_catalog',array('status'=>1,'start_date'=> date('Y-m-d H:i:s'),'tot_product' => $full_catalog_price->cnt),array('cid'=>$cat_from_db->cid));  // remove comment                                    

          // Catalog Entry in designer table

          $catalog_data = array(      
                        'cid'     => $cat_from_db->cid,
                        'ass_cid'   => $cat_from_db->ass_cid,       
                        'c_name'    => $cat_from_db->c_name,
                        'total_product' => $full_catalog_price->cnt,
                        'status'    => 0,
                        'entry_date'=> date('Y-m-d h:i:s')

                      );    

          //echo "<pre>";print_r($catalog_data);echo "</pre>";  

          // Entry in designer table
          $exist_cat_designer = $wpdb->get_var("SELECT id FROM `store_designer` WHERE `ass_cid` LIKE '".$cat_from_db->ass_cid."'");
          if($exist_cat_designer){
            $wpdb->update('store_designer',$catalog_data,array('id' => $exist_cat_designer)); // remove comment   
          }else{
            $wpdb->insert('store_designer',$catalog_data); // remove comment    
          }
          
          // Entry in Data Entry table table
          $exist_cat_data = $wpdb->get_var("SELECT id FROM `store_data` WHERE `ass_cid` LIKE '".$cat_from_db->ass_cid."'");
          if($exist_cat_designer){
            $wpdb->update('store_data',$catalog_data,array('id' => $exist_cat_designer)); // remove comment   
          }else{
            $wpdb->insert('store_data',$catalog_data); // remove comment    
          }
           $msg1[].="Total $tot_ins_pro product uploaded";   
        } 

        

        if( $cat_from_db->status != 0)  

        {

          $msg1[].=" <b> $c_name <b>Catalog already uploaded."; 

        }

        $msg_warn=implode('<br>', $msg);
        $msg_ok=implode('<br>', $msg1);

        ?>
        <script type="text/javascript">
        $(document).ready(function()
        {
            var msg_warn='<?php echo $msg_warn; ?>';
            var msg_ok='<?php echo $msg_ok; ?>';

            if(msg_warn !='')
            {
               jQuery('.custom_class1').css('left','-275px');
               jQuery('#myModal_warning').modal('show');
               jQuery('#msg_lbl').html(msg_warn);
               
            }
            
            if(msg_ok !='')
            {
              jQuery('.custom_class2').css('left','315px');
              jQuery('#myModal_success').modal('show');
              jQuery('#msg_succ_lbl').html(msg_ok);

            }
        });
        </script>
<?php

  }
  else if(isset($_REQUEST['action']) && $_REQUEST['action']=='duplicate_catalog')
  {
      include('map_duplicate_catalog.php'); 
      
  }
  else
  {

    ?>
    <style>
#example1 tr td:nth-child(10) ,#example1 tr td:nth-child(11),
#example1 tr th:nth-child(10) ,#example1 tr th:nth-child(11) {
    display: none;
}
#example1_filter
{
  display: none;
}

</style>
 <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">

          <h3><i class="glyphicon glyphicon-user"></i> Catalog List</h3>

          <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i>Catalog upload</a></li>
            <li><a href="#">ASS catalogs</a></li>
            <li class="active">Catalog List</li>
          </ol>
        </section>

        <!-- Main content -->
        <form name="frm_store_catlog" id="frm_store_catlog" method="post" action="" >

          <input type="hidden" name="page" value="store_admin_LT" >
        
        <section class="content">

        <div class="input-group" style=" margin-bottom:50px; display: block;">
            <a href="admin.php?page=store_admin_LT&action=get_catalog&id=2500" class="floatr pull-right btn btn-info">Get New Catalog From ASS</a>
            
        </div>

        <div class="box box-info" >
                  <div class="box-header" >
                    <h3 class="box-title"><i class="glyphicon glyphicon-list"></i>&nbsp;&nbsp;Filter</h3>
                    <div class="box-tools">
                          <button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                    </div>
                  </div>
                    <div class="box-body" >
                        <div class="row" >

                          <div class="col-md-4" >
                            <p id="select_supplier_name" ></p>
                            
                          </div>

                          <div class="col-md-2" >

                            <p id="select_catlog_name" ></p>
                            
                          </div>
                          <div class="col-md-2" >

                            <p id="select_status" ></p>
                            
                          </div>
                          <div class="col-md-2" >
                            <input type="text" name="txt_search" id="txt_bottled_search" class="form-control" value="" placeholder="Type Text" />
                          </div>

                          <!-- <input type="submit" name="bt_apply" id="bt_apply" value="Filter" class="btn btn-primary"/> -->
                         </div>
                          <div class="row" >

                            <div class="col-md-2" style="margin-top: 12px;">
                            <select class="form-control" id="select_bulk" name="select_bulk" >
                            <option value="-1" >Bulk Action</option>
                            <option value="trash" >Trash</option>
                            <option value="restore" >Restore</option>

                            </select>
                            </div>

                            <input type="button" name="bulk_apply" id="bulk_apply" value="Apply" class="btn btn-primary" style="margin-top: 10px;" onclick="btn_action_product()" />
                        </div>
                    </div> 

                 
              </div>

          <div class="row">
            <div class="col-xs-12">
              
              <div class="box">
                <div class="box-header">
                </div><!-- /.box-header -->
                <div class="box-body">
                  <table id="example1" class="table table-bordered table-striped">
                    <thead>
                      <tr>
                        <th><input type="checkbox" name="chk_all_grp" id="chk_all_grp" class="minimal"></th>
                        <th>ASS ID</th>
                        <th>Catalog</th>
                        <th>Products</th>
                        <th>Supplier</th>
                        <th>Status</th>
                        <th>Process</th>
                        <th>Date</th>
                        <th>Actions</th>
                        <th>Status</th>
                        <th>Catalog</th>
                      </tr>
                    </thead>

                    <tbody>
                      
                      
                    </tbody>
                    <tfoot>
                      <th><input type="checkbox" name="chk_all_grp" id="chk_all_grp" class="minimal"></th>
                        <th>ASS ID</th>
                        <th>Catalog</th>
                        <th>Products</th>
                        <th>Supplier</th>
                        <th>Status</th>
                        <th>Process</th>
                        <th>Date</th>
                        <th>Actions</th>
                        <th>Status</th>
                        <th>Catalog</th>
                    </tfoot>
                    
                  </table>
                </div><!-- /.box-body -->
              </div><!-- /.box -->
            </div><!-- /.col -->
          </div><!-- /.row -->
        </section><!-- /.content -->
      </form>
      </div><!-- /.content-wrapper -->
    <?php

  }

?>


<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog" style="width:750px">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Catalog:<span id="cat_assin"></span></h4>
      </div>
      <div class="modal-body">
        <div class="log_table" id="log_table"> </div>
      </div>
    </div>
  </div>
</div>


<div class="modal fade modal-warning" id="myModal_warning" style="display:none" >
              <div class="modal-dialog">
                <div class="modal-content custom_class1 " >
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                    <h4 class="modal-title"><i class="fa fa-warning"></i>&nbsp;&nbsp; Warning</h4>
                  </div>
                  <div class="modal-body" id="msg_lbl" >
                    
                  </div>
                  <div class="modal-footer">
                    <button type="button" id="close_warning" class="btn btn-outline pull-left" data-dismiss="modal">OK</button>
                    <!-- <button type="button" class="btn btn-outline">Save changes</button> -->
                  </div>
                </div><!-- /.modal-content -->
              </div><!-- /.modal-dialog -->
            </div>

            <div class="modal fade modal-success" id="myModal_success" style="display:none" >
              <div class="modal-dialog">
                <div class="modal-content custom_class2">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                    <h4 class="modal-title"><i class="fa fa-check-circle-o"></i>&nbsp;&nbsp; Success</h4>
                  </div>
                  <div class="modal-body" id="msg_succ_lbl" >
                    
                  </div>
                  <div class="modal-footer">
                    <button type="button" id="close_warning" class="btn btn-outline pull-left" data-dismiss="modal">OK</button>
                    <!-- <button type="button" class="btn btn-outline">Save changes</button> -->
                  </div>
                </div><!-- /.modal-content -->
              </div><!-- /.modal-dialog -->
            </div>



<?php
require('footer.php');
?>
 <?php 
$supplier1=array();
 $suppliers = $wpdb->get_col("SELECT supplier_name FROM `store_catalog` WHERE 1 AND status!=3  GROUP BY supplier_name");
if($suppliers){

foreach($suppliers as $supplier)
{
  $supplier1[] =  trim($supplier);
  }
}
  $b='["'.implode('","', $supplier1).'"]';

$catlog1=array();
 
 $catalogs = $wpdb->get_col("SELECT c_name FROM `store_catalog` WHERE 1 AND status!=3 $wh_sup GROUP BY c_name");

if($catalogs)
{
  $character = array("-");

    foreach($catalogs as $catalog)
    {

         $catlog1[]=trim($catalog);

    }

} 
      $c='["'.implode('","', $catlog1).'"]';


                                ?>
<script src="http://jorjoto.in/wp-content/plugins/product-store-mang/admin_new/jquery.dataTables.columnFilter.js" type="text/javascript"></script>

<script type="text/javascript">

 var plugin_url = '<?php echo plugins_url(); ?>';
      
      //$(window).load(function(){

        $(document).ready(function(){

        $('#example1').dataTable( {
        "bProcessing": true,
        "aoColumnDefs": [
                        {  "bVisible": true, "aTargets": [ 0, 6, 8 ] ,"orderable":false},

                    ] ,
        "ordering": true,
        "order":[[ 7, "desc" ]],
        "bServerSide": true,
        "iDisplayLength":10,
        "sAjaxSource":  plugin_url+'/product-store-mang/admin_new/ajax/store_admin_pagination.php',
       }).columnFilter({aoColumns:[
        null,
        null,
        { sSelector: "#select_catlog_name",type:"select",values:<?php echo $c; ?>},
        null,
        { sSelector: "#select_supplier_name",type:"select",values:<?php echo $b; ?>},
        null,
        null,
        null,
        null,
        { sSelector: "#select_status",type:"select",values:["Pending","Uploaded","Running","Trash"]},
        ]});

     });


      function btn_action_product()
      {
      
      if($('.ckp:checked').length) {
        var chkId = '';
        $('.ckp:checked').each(function() {
        chkId += $(this).val() + ",";
        });
        chkId =  chkId.slice(0,-1);
        
      
        if($('#select_bulk').val() == -1)
        {
           //alert("Please select bulk action.");  
           jQuery('#myModal_warning').modal('show');
           jQuery('#msg_lbl').html('Please select bulk action.');
           return false;
        }
        else
        {
            //$('#selected_product').val(chkId);
          $('#frm_store_catlog').submit();   
        }
      }
      else {  
        jQuery('#myModal_warning').modal('show');
        jQuery('#msg_lbl').html('Please select catalog from below list for apply bulk action.');
        //alert('Please select catalog from below list for apply bulk action.');
        return false;
      }
      return false;
    }

 jQuery('#close_warning').click(function()
 {
    jQuery('#myModal_warning').modal('hide');
 });

      function showcataloglog(id,ass_cid)
      {   
        /*jQuery("#cat_assin").text('');
        jQuery("#log_table").html('');*/
        jQuery("#cat_assin").text(jQuery("#cat_log_name_"+id).text());
        $('#myModal').modal('show');
        jQuery.ajax({
                type:"post",
                data:"log_action=get_catalog_log&ass_id="+ass_cid,
                url:plugin_url+"/product-store-mang/admin_new/ajax/ajax-functions.php",
                success:function(t)
                {

                   jQuery("#log_table").html(t);
                }
               
            });
       }

       $('#txt_bottled_search').keyup(function()
       {
           $('.input-sm').val($(this).val());
           $('.input-sm').keyup();

       });

$(document).ready(function() {
           $('.minimal').click(function(event) { 

        if(this.checked) { // check select status
            $('.ckp').each(function() { //loop through each checkbox
                this.checked = true;  //select all checkboxes with class "checkbox1" 
                             
            });
        }else{
            $('.ckp').each(function() { //loop through each checkbox
                this.checked = false; //deselect all checkboxes with class "checkbox1"   

            });        
        }
    });

           $('#example2').DataTable({
          "paging": true,
          "lengthChange": false,
          "searching": false,
          "ordering": true,
          "info": true,
          "scrollX":"100%",
          "autoWidth": true,
          "columnDefs": [
          {
          "targets": [0,2,8,11],
           orderable: false,
           visible: true,
          }
          ],
          "aaSorting": [],

        });

        jQuery( "#txt_cat_name_search" ).blur(function() 
        {
          checkCNameAvailability();
        });
   
});


function checkCNameAvailability()
{
  
    if(jQuery('#txt_cat_name_search').val() !='')
    { 
      var oname = jQuery('#txt_cat_name_search').val();
      jQuery.ajax({ 
            type: "POST",
            url: STORE_URL+"admin_new/ajax/check_exist.php",
            data: "act=catalog&cname="+oname,
            success: function(responce)
            {   
              if(responce==1)
              {
                jQuery('#myModal_success').modal('show');
                jQuery('#msg_succ_lbl').html('Name Available to Use');
                jQuery('#bt_approve').removeAttr('disabled');
                return false;
              }
              else
              {
                jQuery('#myModal_warning').modal('show');
                jQuery('#msg_lbl').html('Name Already Used');
                jQuery('#bt_approve').attr('disabled','disabled');
                return false; 
              }
            } 
         });
    }
    else
    {
      
      jQuery("#txt_cat_name_search").focus();
      return false;
    }

  
}

 $('#bt_approve').on('click',function(event){
          
      event.preventDefault();
            
            if($('#txt_cat_name_search').val()!='')
            {
            if($('.ckp:checked').length) {
       
        $('#frm_approve_catlog').submit();    
      }
      else 
      { 
        jQuery('#myModal_warning').modal('show');
        jQuery('#msg_lbl').html('Please select atleast one product from below for approved product.');
        return false;
      }
            }else
            {
              jQuery('#myModal_warning').modal('show');
              jQuery('#msg_lbl').html('Please insert our name for approved catalog.');
                    return false;
            }                                
    });
      
   
    </script>

